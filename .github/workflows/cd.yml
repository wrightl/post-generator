name: CD

on:
  push:
    branches: [main]

env:
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP || 'rg-postgenerator-dev' }}
  LOCATION: ${{ vars.LOCATION || 'westeurope' }}
  AZURE_ENV_NAME: dev
  AZURE_AI_LOCATION: ${{ vars.AZURE_AI_LOCATION || 'westeurope' }}
  AZURE_IMAGE_LOCATION: ${{ vars.AZURE_IMAGE_LOCATION || 'swedencentral' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.api_url.outputs.api_url }}
      static_web_app_name: ${{ steps.api_url.outputs.static_web_app_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Create resource group
        run: |
          az group create --name ${{ env.RESOURCE_GROUP }} --location ${{ env.LOCATION }} --output none

      - name: Configure azd environment
        run: |
          SUB_ID=$(az account show --query id -o tsv)
          azd env new ${{ env.AZURE_ENV_NAME }} --subscription "$SUB_ID" --location "${{ env.LOCATION }}" 2>/dev/null || true
          azd env select ${{ env.AZURE_ENV_NAME }}
          azd env set AZURE_RESOURCE_GROUP ${{ env.RESOURCE_GROUP }}
          azd env set AZURE_LOCATION ${{ env.LOCATION }}
          azd env set AZURE_AI_LOCATION ${{ env.AZURE_AI_LOCATION }}
          azd env set AZURE_IMAGE_LOCATION ${{ env.AZURE_IMAGE_LOCATION }}
          azd env set LOCAL_DEV_ONLY "false"
          azd env set AZURE_SQL_ADMIN_LOGIN "${{ vars.AZURE_SQL_ADMIN_LOGIN || 'sqladmin' }}"
          azd env set AZURE_SQL_ADMIN_PASSWORD "${{ secrets.SQL_ADMIN_PASSWORD }}"
          if [ "${{ env.LOCATION }}" = "westeurope" ]; then azd env set DEPLOY_IMAGE_MODEL "false"; else azd env set DEPLOY_IMAGE_MODEL "true"; fi
          azd env set FIREBASE_PROJECT_ID "${{ vars.FIREBASE_PROJECT_ID }}"
          azd env set FIREBASE_CREDENTIAL_JSON_BASE64 "${{ secrets.FIREBASE_CREDENTIAL_JSON_BASE64 }}"
          azd env set CORS_ORIGINS "${{ vars.CORS_ORIGINS }}"
          azd env set MAILGUN_API_KEY "${{ secrets.MAILGUN_API_KEY }}"
          azd env set MAILGUN_DOMAIN "${{ vars.MAILGUN_DOMAIN }}"
          azd env set MAILGUN_FROM_ADDRESS "${{ vars.MAILGUN_FROM_ADDRESS }}"
          azd env set MAILGUN_FROM_NAME "${{ vars.MAILGUN_FROM_NAME }}"

      - name: Provision infrastructure
        run: azd provision --no-prompt

      - name: Set API URL and Static Web App name for frontend
        id: api_url
        run: |
          DEPLOYMENT_NAME=$(az deployment group list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv 2>/dev/null) || true
          if [ -n "$DEPLOYMENT_NAME" ]; then
            API_URL=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query "properties.outputs.apiUrl.value" -o tsv 2>/dev/null) || true
            STATIC_WEB_APP_NAME=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query "properties.outputs.staticWebAppName.value" -o tsv 2>/dev/null) || true
          fi
          if [ -z "$API_URL" ]; then
            FQDN=$(az containerapp show --name postgen-api-${{ env.AZURE_ENV_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null) || true
            [ -n "$FQDN" ] && API_URL="https://$FQDN"
          fi
          if [ -z "$STATIC_WEB_APP_NAME" ]; then
            STATIC_WEB_APP_NAME="postgen-web-${{ env.AZURE_ENV_NAME }}"
          fi
          if [ -n "$API_URL" ]; then
            azd env set NEXT_PUBLIC_API_URL "$API_URL"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi
          echo "static_web_app_name=$STATIC_WEB_APP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy application
        run: azd deploy --no-prompt

  deploy_web:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.api_url != ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/Web/package-lock.json

      - name: Build frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.deploy.outputs.api_url }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_APP_ID }}
        run: |
          cd src/Web
          npm ci || npm install
          npm run build

      - name: Azure Login
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Static Web App deployment token
        id: swa_token
        run: |
          TOKEN=$(az staticwebapp secrets list \
            --name "${{ needs.deploy.outputs.static_web_app_name }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "properties.apiKey" -o tsv 2>/dev/null) || true
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy frontend to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa_token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/Web/out'
          skip_app_build: true
          is_static_export: true
