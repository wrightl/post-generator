name: CD

on:
  push:
    branches: [main]

env:
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP || 'rg-postgenerator-dev' }}
  LOCATION: ${{ vars.LOCATION || 'westeurope' }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'dev' }}
  AZURE_AI_LOCATION: ${{ vars.AZURE_AI_LOCATION || 'westeurope' }}
  AZURE_IMAGE_LOCATION: ${{ vars.AZURE_IMAGE_LOCATION || 'swedencentral' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.api_url.outputs.api_url }}
      web_url: ${{ steps.api_url.outputs.web_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2.2.1

      - name: Azure Developer CLI login
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          clientId=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientId')
          clientSecret=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientSecret')
          tenantId=$(echo "$AZURE_CREDENTIALS" | jq -r '.tenantId')
          azd auth login --client-id "$clientId" --tenant-id "$tenantId" --client-secret "$clientSecret" --no-prompt

      - name: Create resource group
        run: |
          az group create --name ${{ env.RESOURCE_GROUP }} --location ${{ env.LOCATION }} --output none

      - name: Configure azd environment
        run: |
          SUB_ID=$(az account show --query id -o tsv)
          azd env new ${{ env.AZURE_ENV_NAME }} --subscription "$SUB_ID" --location "${{ env.LOCATION }}" 2>/dev/null || true
          azd env select ${{ env.AZURE_ENV_NAME }}
          azd env set AZURE_RESOURCE_GROUP ${{ env.RESOURCE_GROUP }}
          azd env set AZURE_LOCATION ${{ env.LOCATION }}
          azd env set AZURE_AI_LOCATION ${{ env.AZURE_AI_LOCATION }}
          azd env set AZURE_IMAGE_LOCATION ${{ env.AZURE_IMAGE_LOCATION }}
          azd env set LOCAL_DEV_ONLY "false"
          azd env set AZURE_SQL_ADMIN_LOGIN "${{ vars.AZURE_SQL_ADMIN_LOGIN || 'sqladmin' }}"
          azd env set AZURE_SQL_ADMIN_PASSWORD "${{ secrets.SQL_ADMIN_PASSWORD }}"
          if [ "${{ env.LOCATION }}" = "westeurope" ]; then azd env set DEPLOY_IMAGE_MODEL "false"; else azd env set DEPLOY_IMAGE_MODEL "true"; fi
          azd env set FIREBASE_PROJECT_ID "${{ vars.FIREBASE_PROJECT_ID }}"
          azd env set FIREBASE_CREDENTIAL_JSON_BASE64 "${{ secrets.FIREBASE_CREDENTIAL_JSON_BASE64 }}"
          azd env set CORS_ORIGINS "${{ vars.CORS_ORIGINS }}"
          azd env set MAILGUN_API_KEY "${{ secrets.MAILGUN_API_KEY }}"
          azd env set MAILGUN_DOMAIN "${{ vars.MAILGUN_DOMAIN }}"
          azd env set MAILGUN_FROM_ADDRESS "${{ vars.MAILGUN_FROM_ADDRESS }}"
          azd env set MAILGUN_FROM_NAME "${{ vars.MAILGUN_FROM_NAME }}"
          azd env set NEXT_PUBLIC_FIREBASE_API_KEY "${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}"
          azd env set NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN "${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}"
          azd env set NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET "${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}"
          azd env set NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID "${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}"
          azd env set NEXT_PUBLIC_FIREBASE_APP_ID "${{ vars.NEXT_PUBLIC_FIREBASE_APP_ID }}"
          azd env set FIREBASE_API_KEY "${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}"
          azd env set FIREBASE_AUTH_DOMAIN "${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}"
          azd env set FIREBASE_STORAGE_BUCKET "${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}"
          azd env set FIREBASE_MESSAGING_SENDER_ID "${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}"
          azd env set FIREBASE_APP_ID "${{ vars.NEXT_PUBLIC_FIREBASE_APP_ID }}"

      - name: Run what-if
        run: az deployment group what-if --resource-group ${{ env.RESOURCE_GROUP }} --template-file infra/main.bicep

      # - name: Wait for in-progress deployments
      #   run: |
      #     echo "Checking for in-progress deployments..."
      #     MAX_WAIT=600  # 10 minutes max wait
      #     ELAPSED=0
      #     while [ $ELAPSED -lt $MAX_WAIT ]; do
      #       IN_PROGRESS=$(az deployment group list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?properties.provisioningState=='Running' || properties.provisioningState=='Accepted'].name" -o tsv 2>/dev/null || echo "")
      #       if [ -z "$IN_PROGRESS" ]; then
      #         echo "No in-progress deployments found"
      #         break
      #       fi
      #       echo "Waiting for deployments to complete: $IN_PROGRESS"
      #       sleep 30
      #       ELAPSED=$((ELAPSED + 30))
      #     done
      #     if [ $ELAPSED -ge $MAX_WAIT ]; then
      #       echo "Warning: Timeout waiting for deployments to complete"
      #     fi

      # - name: Wait for OpenAI accounts to be ready
      #   run: |
      #     echo "Checking OpenAI account provisioning states..."
      #     MAX_WAIT=600  # 10 minutes max wait
      #     ELAPSED=0
          
      #     # Find all OpenAI accounts in the resource group using resource list instead
      #     OPENAI_ACCOUNTS=$(az resource list --resource-group ${{ env.RESOURCE_GROUP }} --resource-type "Microsoft.CognitiveServices/accounts" --query "[?kind=='OpenAI'].name" -o tsv 2>/dev/null || echo "")
          
      #     if [ -z "$OPENAI_ACCOUNTS" ]; then
      #       echo "No OpenAI accounts found, skipping wait"
      #       exit 0
      #     fi
          
      #     echo "Found OpenAI accounts: $OPENAI_ACCOUNTS"
          
      #     # Wait for all accounts to be ready
      #     while [ $ELAPSED -lt $MAX_WAIT ]; do
      #       ALL_READY=true
      #       for ACCOUNT_NAME in $OPENAI_ACCOUNTS; do
      #         # Use resource show with explicit API version
      #         STATE=$(az resource show --name "$ACCOUNT_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --resource-type "Microsoft.CognitiveServices/accounts" --api-version "2024-10-01" --query 'properties.provisioningState' -o tsv 2>/dev/null || echo "Succeeded")
      #         if [ "$STATE" != "Succeeded" ] && [ "$STATE" != "Creating" ] && [ "$STATE" != "Deleting" ]; then
      #           echo "Account $ACCOUNT_NAME state: $STATE"
      #           if [ "$STATE" != "Failed" ]; then
      #             ALL_READY=false
      #           fi
      #         fi
      #       done
            
      #       if [ "$ALL_READY" = true ]; then
      #         echo "All OpenAI accounts are ready"
      #         break
      #       fi
            
      #       echo "Waiting for OpenAI accounts to be ready... (elapsed: ${ELAPSED}s)"
      #       sleep 30
      #       ELAPSED=$((ELAPSED + 30))
      #     done
          
      #     if [ $ELAPSED -ge $MAX_WAIT ]; then
      #       echo "Warning: Timeout waiting for OpenAI accounts to be ready"
      #       # List final states
      #       for ACCOUNT_NAME in $OPENAI_ACCOUNTS; do
      #         STATE=$(az resource show --name "$ACCOUNT_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --resource-type "Microsoft.CognitiveServices/accounts" --api-version "2024-10-01" --query 'properties.provisioningState' -o tsv 2>/dev/null || echo "Unknown")
      #         echo "  $ACCOUNT_NAME: $STATE"
      #       done
      #     fi

      - name: Provision infrastructure
        run: azd provision --no-prompt

      - name: Set API URL for frontend
        id: api_url
        run: |
          DEPLOYMENT_NAME=$(az deployment group list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv 2>/dev/null) || true
          if [ -n "$DEPLOYMENT_NAME" ]; then
            API_URL=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query "properties.outputs.apiUrl.value" -o tsv 2>/dev/null) || true
            WEB_URL=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query "properties.outputs.webUrl.value" -o tsv 2>/dev/null) || true
          fi
          if [ -z "$API_URL" ]; then
            FQDN=$(az containerapp show --name postgen-api-${{ env.AZURE_ENV_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null) || true
            [ -n "$FQDN" ] && API_URL="https://$FQDN"
          fi
          if [ -z "$WEB_URL" ]; then
            WEB_FQDN=$(az containerapp show --name postgen-web-${{ env.AZURE_ENV_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null) || true
            [ -n "$WEB_FQDN" ] && WEB_URL="https://$WEB_FQDN"
          fi
          if [ -n "$API_URL" ]; then
            azd env set NEXT_PUBLIC_API_URL "$API_URL"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi
          if [ -n "$WEB_URL" ]; then
            echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          fi

      - name: Deploy application
        run: azd deploy --no-prompt
