{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "10260284468776774447"
    }
  },
  "parameters": {
    "baseName": {
      "type": "string",
      "defaultValue": "postgen",
      "metadata": {
        "description": "Base name for resources (e.g. postgen)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Environment name (e.g. dev, prod)"
      }
    },
    "localDevOnly": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploy only Azure OpenAI for local dev (no ACR, Container App, Function, etc.)"
      }
    },
    "deployImageModel": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "When true, deploy dall-e-3 image model. Set false in regions where Standard SKU is not supported (e.g. West Europe)."
      }
    },
    "openAIChatLocation": {
      "type": "string",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Region for chat (GPT). From AZURE_AI_LOCATION."
      }
    },
    "openAIImageLocation": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Region for image (DALL-E). From AZURE_IMAGE_LOCATION."
      }
    },
    "sqlAdminLogin": {
      "type": "string",
      "defaultValue": "sqladmin",
      "metadata": {
        "description": "SQL Server administrator login. From AZURE_SQL_ADMIN_LOGIN."
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "SQL Server administrator password. From AZURE_SQL_ADMIN_PASSWORD secret."
      }
    },
    "apiImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Initial API container image (replaced by CD)"
      }
    },
    "webImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Initial Web container image (replaced by CD)"
      }
    },
    "firebaseProjectId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase project ID. From FIREBASE_PROJECT_ID."
      }
    },
    "firebaseCredentialJsonBase64": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase service account JSON (base64). From FIREBASE_CREDENTIAL_JSON_BASE64."
      }
    },
    "firebaseApiKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase API key. From NEXT_PUBLIC_FIREBASE_API_KEY."
      }
    },
    "firebaseAuthDomain": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase auth domain. From NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN."
      }
    },
    "firebaseStorageBucket": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase storage bucket. From NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET."
      }
    },
    "firebaseMessagingSenderId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase messaging sender ID. From NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID."
      }
    },
    "firebaseAppId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Firebase app ID. From NEXT_PUBLIC_FIREBASE_APP_ID."
      }
    },
    "corsOrigins": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "CORS allowed origins (comma-separated). From CORS_ORIGINS."
      }
    },
    "mailgunApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Mailgun API key. From MAILGUN_API_KEY."
      }
    },
    "mailgunDomain": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Mailgun domain. From MAILGUN_DOMAIN."
      }
    },
    "mailgunFromAddress": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Mailgun from address. From MAILGUN_FROM_ADDRESS."
      }
    },
    "mailgunFromName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Mailgun from name. From MAILGUN_FROM_NAME."
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id, parameters('baseName'))]",
    "acrName": "[format('{0}acr{1}', parameters('baseName'), variables('uniqueSuffix'))]",
    "containerAppEnvName": "[format('{0}-env-{1}', parameters('baseName'), parameters('environmentName'))]",
    "apiAppName": "[format('{0}-api-{1}', parameters('baseName'), parameters('environmentName'))]",
    "webAppName": "[format('{0}-web-{1}', parameters('baseName'), parameters('environmentName'))]",
    "storageName": "[toLower(replace(format('{0}{1}', parameters('baseName'), variables('uniqueSuffix')), '-', ''))]",
    "logAnalyticsName": "[format('{0}-logs-{1}', parameters('baseName'), parameters('environmentName'))]",
    "openAIChatName": "[format('{0}-openai-chat-{1}-{2}', parameters('baseName'), parameters('environmentName'), variables('uniqueSuffix'))]",
    "openAIImageName": "[format('{0}-openai-image-{1}-{2}', parameters('baseName'), parameters('environmentName'), variables('uniqueSuffix'))]",
    "sqlServerName": "[format('{0}-sql-{1}-{2}', parameters('baseName'), parameters('environmentName'), variables('uniqueSuffix'))]",
    "sqlDatabaseName": "postgenerator",
    "blobContainerName": "post-images",
    "deploymentStorageContainerName": "[format('app-package-{0}-{1}', parameters('baseName'), parameters('environmentName'))]",
    "openAIImageAccountNameLocal": "[if(and(parameters('localDevOnly'), parameters('deployImageModel')), variables('openAIImageName'), '')]",
    "openAIImageAccountNameProd": "[coalesce(if(and(not(parameters('localDevOnly')), parameters('deployImageModel')), variables('openAIImageName'), null()), '')]"
  },
  "resources": [
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-11-01-preview",
      "name": "[variables('acrName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Basic"
      },
      "properties": {
        "adminUserEnabled": true
      }
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[variables('storageName')]",
      "location": "[parameters('location')]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS"
      }
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}', variables('storageName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}/{2}', variables('storageName'), 'default', variables('blobContainerName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName'), 'default')]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}/{2}', variables('storageName'), 'default', variables('deploymentStorageContainerName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName'), 'default')]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2022-05-01-preview",
      "name": "[variables('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdminLogin')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "version": "12.0"
      }
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2022-05-01-preview",
      "name": "[format('{0}/{1}', variables('sqlServerName'), variables('sqlDatabaseName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "S0",
        "tier": "Standard"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2022-05-01-preview",
      "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "condition": "[parameters('localDevOnly')]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2024-10-01",
      "name": "[variables('openAIChatName')]",
      "location": "[parameters('openAIChatLocation')]",
      "kind": "OpenAI",
      "sku": {
        "name": "S0"
      },
      "properties": {}
    },
    {
      "condition": "[parameters('localDevOnly')]",
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('openAIChatName'), 'gpt-4o')]",
      "sku": {
        "name": "GlobalStandard",
        "capacity": 10
      },
      "properties": {
        "model": {
          "name": "gpt-4o",
          "format": "OpenAI"
        },
        "raiPolicyName": "Microsoft.Default",
        "versionUpgradeOption": "OnceCurrentVersionExpired"
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName'))]"
      ]
    },
    {
      "condition": "[and(parameters('localDevOnly'), parameters('deployImageModel'))]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2024-10-01",
      "name": "[variables('openAIImageName')]",
      "location": "[parameters('openAIImageLocation')]",
      "kind": "OpenAI",
      "sku": {
        "name": "S0"
      },
      "properties": {}
    },
    {
      "condition": "[and(parameters('localDevOnly'), parameters('deployImageModel'))]",
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('openAIImageName'), 'dall-e-3')]",
      "sku": {
        "name": "Standard",
        "capacity": 1
      },
      "properties": {
        "model": {
          "name": "dall-e-3",
          "format": "OpenAI"
        },
        "raiPolicyName": "Microsoft.Default",
        "versionUpgradeOption": "OnceCurrentVersionExpired"
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2024-10-01",
      "name": "[variables('openAIChatName')]",
      "location": "[parameters('openAIChatLocation')]",
      "kind": "OpenAI",
      "sku": {
        "name": "S0"
      },
      "properties": {}
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('openAIChatName'), 'gpt-4o')]",
      "sku": {
        "name": "GlobalStandard",
        "capacity": 10
      },
      "properties": {
        "model": {
          "name": "gpt-4o",
          "format": "OpenAI"
        },
        "raiPolicyName": "Microsoft.Default",
        "versionUpgradeOption": "OnceCurrentVersionExpired"
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName'))]"
      ]
    },
    {
      "condition": "[and(not(parameters('localDevOnly')), parameters('deployImageModel'))]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2024-10-01",
      "name": "[variables('openAIImageName')]",
      "location": "[parameters('openAIImageLocation')]",
      "kind": "OpenAI",
      "sku": {
        "name": "S0"
      },
      "properties": {}
    },
    {
      "condition": "[and(not(parameters('localDevOnly')), parameters('deployImageModel'))]",
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('openAIImageName'), 'dall-e-3')]",
      "sku": {
        "name": "Standard",
        "capacity": 1
      },
      "properties": {
        "model": {
          "name": "dall-e-3",
          "format": "OpenAI"
        },
        "raiPolicyName": "Microsoft.Default",
        "versionUpgradeOption": "OnceCurrentVersionExpired"
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[variables('containerAppEnvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('apiAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 8080,
            "transport": "auto",
            "allowInsecure": false
          },
          "registries": [
            {
              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').loginServer]",
              "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').username]",
              "passwordSecretRef": "acr-password"
            }
          ],
          "secrets": "[concat(createArray(createObject('name', 'acr-password', 'value', listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').passwords[0].value), createObject('name', 'openai-api-key', 'value', listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName')), '2024-10-01').key1), createObject('name', 'sql-connection-string', 'value', format('Server=tcp:{0},1433;Initial Catalog={1};Persist Security Info=False;User ID={2};Password={3};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), '2022-05-01-preview').fullyQualifiedDomainName, variables('sqlDatabaseName'), parameters('sqlAdminLogin'), parameters('sqlAdminPassword'))), createObject('name', 'blob-connection-string', 'value', format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageName')), '2023-01-01').keys[0].value))), if(parameters('deployImageModel'), createArray(createObject('name', 'openai-image-api-key', 'value', listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName')), '2024-10-01').key1)), createArray()), if(not(equals(parameters('firebaseCredentialJsonBase64'), '')), createArray(createObject('name', 'firebase-credential-base64', 'value', parameters('firebaseCredentialJsonBase64'))), createArray()), if(not(equals(parameters('mailgunApiKey'), '')), createArray(createObject('name', 'mailgun-api-key', 'value', parameters('mailgunApiKey'))), createArray()))]"
        },
        "template": {
          "containers": [
            {
              "name": "api",
              "image": "[parameters('apiImage')]",
              "resources": {
                "cpu": "[json('0.5')]",
                "memory": "1Gi"
              },
              "env": "[concat(createArray(createObject('name', 'AzureOpenAI__Endpoint', 'value', reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName')), '2024-10-01').endpoint), createObject('name', 'AzureOpenAI__ApiKey', 'secretRef', 'openai-api-key'), createObject('name', 'AzureOpenAI__ChatDeploymentName', 'value', 'gpt-4o'), createObject('name', 'AzureOpenAI__ImageDeploymentName', 'value', 'dall-e-3'), createObject('name', 'ConnectionStrings__DefaultConnection', 'secretRef', 'sql-connection-string'), createObject('name', 'BlobStorage__ConnectionString', 'secretRef', 'blob-connection-string'), createObject('name', 'BlobStorage__ContainerName', 'value', variables('blobContainerName')), createObject('name', 'Firebase__ProjectId', 'value', parameters('firebaseProjectId')), createObject('name', 'Cors__Origins', 'value', parameters('corsOrigins')), createObject('name', 'Mailgun__Domain', 'value', parameters('mailgunDomain')), createObject('name', 'Mailgun__FromAddress', 'value', parameters('mailgunFromAddress')), createObject('name', 'Mailgun__FromName', 'value', parameters('mailgunFromName'))), if(parameters('deployImageModel'), createArray(createObject('name', 'AzureOpenAI__ImageEndpoint', 'value', reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName')), '2024-10-01').endpoint), createObject('name', 'AzureOpenAI__ImageApiKey', 'secretRef', 'openai-image-api-key')), createArray()), if(not(equals(parameters('firebaseCredentialJsonBase64'), '')), createArray(createObject('name', 'Firebase__CredentialJsonBase64', 'secretRef', 'firebase-credential-base64')), createArray()), if(not(equals(parameters('mailgunApiKey'), '')), createArray(createObject('name', 'Mailgun__ApiKey', 'secretRef', 'mailgun-api-key')), createArray()))]"
            }
          ],
          "scale": {
            "minReplicas": 0,
            "maxReplicas": 3,
            "rules": [
              {
                "name": "http",
                "http": {
                  "metadata": {
                    "concurrentRequests": "10"
                  },
                  "auth": []
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName'))]",
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName'))]",
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName'))]"
      ]
    },
    {
      "condition": "[not(parameters('localDevOnly'))]",
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 3000,
            "transport": "auto",
            "allowInsecure": false
          },
          "registries": [
            {
              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').loginServer]",
              "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').username]",
              "passwordSecretRef": "acr-password"
            }
          ],
          "secrets": [
            {
              "name": "acr-password",
              "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').passwords[0].value]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "web",
              "image": "[parameters('webImage')]",
              "resources": {
                "cpu": "[json('0.5')]",
                "memory": "1Gi"
              },
              "env": [
                {
                  "name": "PORT",
                  "value": "3000"
                },
                {
                  "name": "NEXT_PUBLIC_API_URL",
                  "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01').configuration.ingress.fqdn)]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_API_KEY",
                  "value": "[parameters('firebaseApiKey')]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN",
                  "value": "[parameters('firebaseAuthDomain')]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_PROJECT_ID",
                  "value": "[parameters('firebaseProjectId')]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET",
                  "value": "[parameters('firebaseStorageBucket')]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID",
                  "value": "[parameters('firebaseMessagingSenderId')]"
                },
                {
                  "name": "NEXT_PUBLIC_FIREBASE_APP_ID",
                  "value": "[parameters('firebaseAppId')]"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": 0,
            "maxReplicas": 3,
            "rules": [
              {
                "name": "http",
                "http": {
                  "metadata": {
                    "concurrentRequests": "10"
                  },
                  "auth": []
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]",
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]"
      ]
    }
  ],
  "outputs": {
    "acrLoginServer": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-11-01-preview').loginServer, '')]"
    },
    "acrName": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), variables('acrName'), '')]"
    },
    "apiAppName": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), variables('apiAppName'), '')]"
    },
    "apiAppFqdn": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01').configuration.ingress.fqdn, '')]"
    },
    "apiUrl": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01').configuration.ingress.fqdn), '')]"
    },
    "webAppName": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), variables('webAppName'), '')]"
    },
    "webAppFqdn": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), reference(resourceId('Microsoft.App/containerApps', variables('webAppName')), '2024-03-01').configuration.ingress.fqdn, '')]"
    },
    "webUrl": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('webAppName')), '2024-03-01').configuration.ingress.fqdn), '')]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[if(parameters('localDevOnly'), reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName')), '2024-10-01').endpoint, reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIChatName')), '2024-10-01').endpoint)]"
    },
    "openAIImageEndpoint": {
      "type": "string",
      "value": "[if(parameters('localDevOnly'), if(and(parameters('localDevOnly'), parameters('deployImageModel')), reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName')), '2024-10-01').endpoint, ''), coalesce(tryGet(tryGet(if(and(not(parameters('localDevOnly')), parameters('deployImageModel')), reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAIImageName')), '2024-10-01', 'full'), null()), 'properties'), 'endpoint'), ''))]"
    },
    "openAIImageAccountName": {
      "type": "string",
      "value": "[if(parameters('localDevOnly'), variables('openAIImageAccountNameLocal'), variables('openAIImageAccountNameProd'))]"
    },
    "openAIChatAccountName": {
      "type": "string",
      "value": "[if(parameters('localDevOnly'), variables('openAIChatName'), variables('openAIChatName'))]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[if(not(parameters('localDevOnly')), variables('storageName'), '')]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    }
  }
}